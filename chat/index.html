<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Global SeatCon 2025 - Conference Chat</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 환경 설정 스크립트 -->
    <script src="../js/env-config.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 로그인 화면 -->
        <div id="login-container" class="container">
            <div class="login-form">
                <h1 class="title" data-i18n="app.title">Global SeatCon 2025</h1>
                <h2 class="subtitle" data-i18n="login.subtitle">Conference Chat</h2>
                
                <div class="form-group">
                    <label for="username" data-i18n="login.username">Username</label>
                    <input type="text" id="username" placeholder="Enter your name" data-i18n-placeholder="login.username.placeholder">
                </div>
                
                <div class="form-group">
                    <label for="language-select" data-i18n="login.language">Preferred Language</label>
                    <select id="language-select">
                        <option value="en" selected data-i18n="languages.english">English</option>
                        <option value="ko" data-i18n="languages.korean">Korean</option>
                        <option value="ja" data-i18n="languages.japanese">Japanese</option>
                        <option value="zh" data-i18n="languages.chinese">Chinese</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="room-select" data-i18n="login.chatroom">Select Chatroom</label>
                    <select id="room-select">
                        <!-- 채팅방 목록은 JavaScript로 동적 로드 -->
                        <option value="" disabled selected data-i18n="login.chatroom.loading">Loading...</option>
                    </select>
                </div>
                
                <div id="private-room-code" class="form-group hidden">
                    <label for="access-code" data-i18n="login.accessCode">Access Code</label>
                    <input type="password" id="access-code" placeholder="Enter private chatroom code" data-i18n-placeholder="login.accessCode.placeholder">
                </div>
                
                <div class="error-message" id="login-error"></div>
                
                <button id="login-button" class="primary-button" data-i18n="login.button">Enter</button>
                
                <div class="connection-status">
                    <span id="connection-indicator" class="online"></span>
                    <span id="connection-text" data-i18n="connection.online">Online</span>
                </div>
            </div>
        </div>
        
        <!-- 채팅 화면 -->
        <div id="chat-container" class="container hidden">
            <header class="chat-header">
                <h2 id="room-name">Chatroom Name</h2>
                <div class="header-actions">
                    <div class="language-display">
                        <span data-i18n="chat.language">Language</span>: <span id="current-language">English</span>
                        <button id="change-language" class="icon-button" title="Change Language">
                            🌐
                        </button>
                    </div>
                    <button id="user-list-toggle" class="icon-button" title="User List">
                        👥
                    </button>
                    <button id="exit-chat" class="icon-button" title="Exit">
                        🚪
                    </button>
                </div>
            </header>
            
            <div class="chat-content">
                <div class="message-container" id="message-container">
                    <!-- 메시지는 JavaScript로 동적 로드 -->
                </div>
                
                <div class="user-list-panel" id="user-list-panel">
                    <h3 data-i18n="chat.users">User List</h3>
                    <ul id="user-list">
                        <!-- 사용자 목록은 JavaScript로 동적 로드 -->
                    </ul>
                </div>
            </div>
            
            <div class="reply-preview" id="reply-preview">
                <div class="reply-content"></div>
                <button class="cancel-reply">✕</button>
            </div>
            
            <div class="message-input-container">
                <textarea 
                    id="message-input" 
                    placeholder="Type your message..."
                    data-i18n-placeholder="chat.messageInput.placeholder"
                ></textarea>
                <button id="send-button" class="send-button" title="Send">
                    ➤
                </button>
            </div>
            
            <div class="connection-status chat-connection-status">
                <span id="chat-connection-indicator" class="online"></span>
                <span id="chat-connection-text" data-i18n="connection.online">Online</span>
                <div id="sync-status" class="hidden">
                    <span class="sync-icon">🔄</span>
                    <span data-i18n="connection.syncing">Syncing...</span>
                </div>
            </div>
        </div>
        
        <!-- 언어 변경 모달 -->
        <div id="language-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 data-i18n="modal.changeLanguage.title">Change Language</h3>
                    <button class="close-modal">✕</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="modal-language-select" data-i18n="modal.changeLanguage.selectLanguage">Select Preferred Language</label>
                        <select id="modal-language-select">
                            <option value="en" selected data-i18n="languages.english">English</option>
                            <option value="ko" data-i18n="languages.korean">Korean</option>
                            <option value="ja" data-i18n="languages.japanese">Japanese</option>
                            <option value="zh" data-i18n="languages.chinese">Chinese</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="language-save" class="primary-button" data-i18n="modal.save">Save</button>
                    <button class="secondary-button close-modal" data-i18n="modal.cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 서비스 스크립트 -->
    <script src="../js/config.js"></script>
    <script src="../js/services/dbService.js"></script>
    <script src="../js/services/realtimeService.js"></script>
    <script src="../js/services/translationService.js"></script>
    <script src="../js/services/userService.js"></script>
    <script src="../js/services/chatService.js"></script>
    <script src="../js/services/offlineService.js"></script>

    <!-- 모듈화된 앱 스크립트 (로드 순서 중요) -->
    <script>
        // 전역 APP 객체 정의 (앱의 모든 모듈이 공유할 객체)
        window.APP = {
            state: {
                initialized: false,
                isLoggedIn: false,
                currentUser: null,
                currentRoomId: null,
                currentRoom: null,
                preferredLanguage: 'en',
                isUserListVisible: false,
                activityInterval: null,
                servicesReady: false,
                isInitializing: false,
                userListUpdateInterval: null
            },
            elements: {},
            messages: {
                lastMessageTime: null,
                pendingScrollToBottom: false
            },
            performance: {
                userListUpdateInterval: 30000,
                activityUpdateInterval: 60000,
                messageRenderBatchSize: 10,
                renderTimer: null,
                userListUpdateTimer: null
            }
        };
    </script>
    <script src="../js/modules/app-core.js"></script>
    <script src="../js/modules/app-ui.js"></script>
    <script src="../js/modules/app-i18n.js"></script>
    <script src="../js/modules/app-chat.js"></script>
    <script src="../js/modules/app-users.js"></script>
    <script src="../js/modules/app-rooms.js"></script>
    <script src="../js/modules/main.js"></script>
    <script>
        // 메인 페이지에서 선택한 언어로 기본 언어 설정
        document.addEventListener('DOMContentLoaded', function() {
            // localStorage에서 선호 언어 가져오기
            const savedLanguage = localStorage.getItem('preferredLanguage') || 'en';
            // 선호 언어 선택 요소 설정
            const languageSelect = document.getElementById('language-select');
            if (languageSelect) {
                languageSelect.value = savedLanguage;
                // 이벤트 발생
                const event = new Event('change');
                languageSelect.dispatchEvent(event);
            }
        });
    </script>
</body>
</html>
