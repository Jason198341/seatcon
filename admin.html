<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Global SeatCon 2025 - 관리자 페이지</title>
    <link rel="stylesheet" href="css/admin.css">
    <!-- Supabase 서비스 사용을 위한 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 환경 설정 스크립트 - 순서 중요 -->
    <script src="js/env-config.js"></script>
    <script src="js/config.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- 로그인 화면 -->
        <div id="admin-login-container" class="container">
            <div class="login-form">
                <h1 class="title">Global SeatCon 2025</h1>
                <h2 class="subtitle">관리자 페이지</h2>
                
                <div class="form-group">
                    <label for="admin-id">관리자 ID</label>
                    <input type="text" id="admin-id" placeholder="관리자 ID 입력">
                </div>
                
                <div class="form-group">
                    <label for="admin-password">비밀번호</label>
                    <input type="password" id="admin-password" placeholder="비밀번호 입력">
                </div>
                
                <div class="error-message" id="admin-login-error"></div>
                
                <button id="admin-login-button" class="primary-button">로그인</button>
                
                <div class="admin-help" style="margin-top: 20px; background-color: #f0f4f8; padding: 10px; border-radius: 5px; border-left: 3px solid #3f51b5;">
                    <p style="font-size: 0.9rem; margin: 0;">기본 관리자 계정: <strong>ID</strong> - kcmmer / <strong>비밀번호</strong> - rnrud9881@@HH</p>
                </div>
            </div>
        </div>
        
        <!-- 관리자 대시보드 -->
        <div id="admin-dashboard" class="container hidden">
            <header class="admin-header">
                <h1>Global SeatCon 2025 관리자 페이지</h1>
                <button id="admin-logout" class="secondary-button">로그아웃</button>
            </header>
            
            <div class="admin-tabs">
                <button class="tab-button active" data-tab="chatrooms">채팅방 관리</button>
                <button class="tab-button" data-tab="users">사용자 관리</button>
                <button class="tab-button" data-tab="stats">통계 및 상태</button>
            </div>
            
            <div class="admin-content">
                <!-- 채팅방 관리 탭 -->
                <div id="chatrooms-tab" class="tab-content active">
                    <div class="tab-header">
                        <h2>채팅방 관리</h2>
                        <button id="create-room-button" class="primary-button">새 채팅방 생성</button>
                    </div>
                    
                    <div class="rooms-list-container">
                        <table class="rooms-table">
                            <thead>
                                <tr>
                                    <th>이름</th>
                                    <th>설명</th>
                                    <th>생성일</th>
                                    <th>상태</th>
                                    <th>최대 인원</th>
                                    <th>접근 제한</th>
                                    <th>정렬 순서</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="rooms-list">
                                <!-- 채팅방 목록은 JavaScript로 동적 로드 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 사용자 관리 탭 -->
                <div id="users-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>사용자 관리</h2>
                        <div class="search-container">
                            <input type="text" id="user-search" placeholder="사용자 검색...">
                            <button id="user-search-button">검색</button>
                        </div>
                    </div>
                    
                    <div class="users-list-container">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>사용자 ID</th>
                                    <th>사용자명</th>
                                    <th>선호 언어</th>
                                    <th>현재 채팅방</th>
                                    <th>마지막 활동</th>
                                    <th>권한</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="users-list">
                                <!-- 사용자 목록은 JavaScript로 동적 로드 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 통계 및 상태 탭 -->
                <div id="stats-tab" class="tab-content">
                    <div class="tab-header">
                        <h2>통계 및 상태</h2>
                        <button id="refresh-stats" class="secondary-button">새로고침</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>사용자 통계</h3>
                            <div class="stat-content" id="user-stats">
                                <div class="stat-item">
                                    <span class="stat-label">총 사용자 수</span>
                                    <span class="stat-value" id="total-users">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">현재 활성 사용자</span>
                                    <span class="stat-value" id="active-users">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>채팅방 통계</h3>
                            <div class="stat-content" id="room-stats">
                                <div class="stat-item">
                                    <span class="stat-label">총 채팅방 수</span>
                                    <span class="stat-value" id="total-rooms">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">활성 채팅방</span>
                                    <span class="stat-value" id="active-rooms">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>메시지 통계</h3>
                            <div class="stat-content" id="message-stats">
                                <div class="stat-item">
                                    <span class="stat-label">총 메시지 수</span>
                                    <span class="stat-value" id="total-messages">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">오늘 메시지</span>
                                    <span class="stat-value" id="today-messages">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3>시스템 상태</h3>
                            <div class="stat-content" id="system-stats">
                                <div class="stat-item">
                                    <span class="stat-label">DB 연결 상태</span>
                                    <span class="stat-value" id="db-status">-</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">번역 API 상태</span>
                                    <span class="stat-value" id="translation-status">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 채팅방 생성/수정 모달 -->
        <div id="room-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="room-modal-title">새 채팅방 생성</h3>
                    <button class="close-modal">✕</button>
                </div>
                <div class="modal-body">
                    <form id="room-form">
                        <input type="hidden" id="room-id">
                        
                        <div class="form-group">
                            <label for="room-name-input">채팅방 이름</label>
                            <input type="text" id="room-name-input" placeholder="채팅방 이름 입력" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="room-description">설명</label>
                            <textarea id="room-description" placeholder="채팅방 설명 입력"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="room-max-users">최대 사용자 수</label>
                            <input type="number" id="room-max-users" min="1" max="1000" value="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="room-sort-order">정렬 순서</label>
                            <input type="number" id="room-sort-order" min="0" value="0">
                            <small>낮은 번호가 먼저 표시됩니다</small>
                        </div>
                        
                        <div class="form-group checkbox">
                            <input type="checkbox" id="room-is-active" checked>
                            <label for="room-is-active">활성화</label>
                        </div>
                        
                        <div class="form-group checkbox">
                            <input type="checkbox" id="room-is-private">
                            <label for="room-is-private">비공개 채팅방</label>
                        </div>
                        
                        <div id="access-code-container" class="form-group hidden">
                            <label for="room-access-code">접근 코드</label>
                            <input type="text" id="room-access-code" placeholder="비공개 채팅방 접근 코드 입력">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="save-room" class="primary-button">저장</button>
                    <button class="secondary-button close-modal">취소</button>
                </div>
            </div>
        </div>
        
        <!-- 사용자 수정 모달 -->
        <div id="user-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>사용자 정보 수정</h3>
                    <button class="close-modal">✕</button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <input type="hidden" id="edit-user-id">
                        
                        <div class="form-group">
                            <label for="edit-username">사용자명</label>
                            <input type="text" id="edit-username" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-user-role">권한</label>
                            <select id="edit-user-role">
                                <option value="user">일반 사용자</option>
                                <option value="admin">관리자</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="save-user" class="primary-button">저장</button>
                    <button class="secondary-button close-modal">취소</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 표시기 -->
    <div class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- 서비스 스크립트 -->
    <script src="js/services/dbService.js"></script>
    <script src="js/services/userService.js"></script>
    <script src="js/services/translationService.js"></script>

    <!-- 디버그 모드 직접 로그인 스크립트 -->
    <script>
    // 디버그용 직접 로그인 함수 추가
    document.addEventListener('DOMContentLoaded', function() {
        // 환경 설정과 서비스가 로드된 후 실행
        setTimeout(function() {
            console.log('관리자 로그인 도우미 초기화');
            
            // 로그인 도우미 기능
            const adminLoginHelper = function() {
                // 관리자 ID와 비밀번호 확인하기 위한 디버그 로그
                if (window.CONFIG) {
                    console.log('관리자 정보:', {
                        ADMIN_ID: window.CONFIG.ADMIN_ID,
                        ADMIN_PASSWORD_LENGTH: window.CONFIG.ADMIN_PASSWORD ? window.CONFIG.ADMIN_PASSWORD.length : 0
                    });
                } else {
                    console.warn('CONFIG 객체를 찾을 수 없습니다.');
                }
                
                // authenticateAdmin 함수 테스트용 직접 로그인 구현
                const adminLogin = async function(adminId, password) {
                    console.log('직접 로그인 시도:', adminId);
                    
                    // config.js에서 관리자 정보 확인
                    const correctId = window.CONFIG && window.CONFIG.ADMIN_ID;
                    const correctPassword = window.CONFIG && window.CONFIG.ADMIN_PASSWORD;
                    
                    const isValid = (adminId === correctId && password === correctPassword);
                    
                    if (isValid) {
                        console.log('관리자 인증 성공');
                        
                        // 관리자 세션 저장 (로컬 스토리지 사용)
                        localStorage.setItem('admin_session', JSON.stringify({
                            id: adminId,
                            role: 'admin',
                            timestamp: new Date().getTime()
                        }));
                        
                        return true;
                    } else {
                        console.warn('관리자 인증 실패');
                        return false;
                    }
                };
                
                // 로그인 버튼 이벤트 핸들러 오버라이드
                const adminLoginButton = document.getElementById('admin-login-button');
                if (adminLoginButton) {
                    adminLoginButton.addEventListener('click', async function() {
                        const adminId = document.getElementById('admin-id').value;
                        const password = document.getElementById('admin-password').value;
                        const adminLoginError = document.getElementById('admin-login-error');
                        
                        if (!adminId || !password) {
                            if (adminLoginError) {
                                adminLoginError.textContent = '관리자 ID와 비밀번호를 모두 입력해주세요.';
                                setTimeout(() => { adminLoginError.textContent = ''; }, 3000);
                            }
                            return;
                        }
                        
                        // 로딩 표시
                        const loadingOverlay = document.querySelector('.loading-overlay');
                        if (loadingOverlay) {
                            loadingOverlay.classList.remove('hidden');
                        }
                        
                        try {
                            // 직접 로그인 수행
                            const isSuccess = await adminLogin(adminId, password);
                            
                            if (isSuccess) {
                                // 성공 시 관리자 페이지로 이동
                                location.reload();
                            } else {
                                // 실패 시 오류 메시지 표시
                                if (adminLoginError) {
                                    adminLoginError.textContent = '관리자 ID 또는 비밀번호가 올바르지 않습니다.';
                                    setTimeout(() => { adminLoginError.textContent = ''; }, 3000);
                                }
                            }
                        } catch (error) {
                            console.error('로그인 처리 중 오류:', error);
                            if (adminLoginError) {
                                adminLoginError.textContent = '로그인 처리 중 오류가 발생했습니다.';
                                setTimeout(() => { adminLoginError.textContent = ''; }, 3000);
                            }
                        } finally {
                            // 로딩 숨기기
                            if (loadingOverlay) {
                                loadingOverlay.classList.add('hidden');
                            }
                        }
                    });
                }
                
                // Enter 키 이벤트 추가
                const adminIdInput = document.getElementById('admin-id');
                const adminPasswordInput = document.getElementById('admin-password');
                
                if (adminIdInput) {
                    adminIdInput.addEventListener('keypress', e => {
                        if (e.key === 'Enter') {
                            if (adminPasswordInput) adminPasswordInput.focus();
                        }
                    });
                }
                
                if (adminPasswordInput) {
                    adminPasswordInput.addEventListener('keypress', e => {
                        if (e.key === 'Enter') {
                            if (adminLoginButton) adminLoginButton.click();
                        }
                    });
                }
            };
            
            // 로그인 도우미 실행
            adminLoginHelper();
        }, 1000);
    });
    </script>
    
    <!-- 관리자 페이지 스크립트 -->
    <script src="js/admin.js"></script>
</body>
</html>
